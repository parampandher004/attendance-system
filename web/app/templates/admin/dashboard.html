{% extends "base.html" %} {% block title %}Admin Dashboard{% endblock %} {%
block content %}

<style>
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
  }

  #uploadModal {
    z-index: 1100 !important;
  }

  #imageViewerModal {
    z-index: 1100 !important;
  }

  .modal.show {
    display: flex !important;
  }
</style>

<div class="main" id="main">
  <!-- Admin Overview Grid -->
  <div class="compartments">
    <div class="compartment">
      <div class="overview-wrapper" style="margin-bottom: 1rem">
        <div class="grid-container">
          <div class="overview-card avatar">
            <div class="img-container">
              <img
                src="{{ url_for('static', filename='images/teacher-avatar-male.jpg') }}"
                alt="Admin"
                style="width: 100%; height: 100%; object-fit: cover"
              />
            </div>
            <div class="avatar-meta">
              <div class="welcome-label">Administrator</div>
              <div id="admin-name" class="student-name">{{ session.name }}</div>
              <div
                id="admin-role-text"
                class="recognition-time"
                style="
                  margin-top: 0.25rem;
                  color: var(--text-muted);
                  font-size: 0.9rem;
                "
              >
                System Manager
              </div>
            </div>
          </div>

          <div class="overview-card info-1">
            <div class="card-label">Total Classes</div>
            <div id="admin-classes-count" class="card-value">‚Äî</div>
          </div>

          <div class="overview-card info-2">
            <div class="card-label">Total Teachers</div>
            <div id="admin-teachers-count" class="card-value">‚Äî</div>
          </div>

          <div class="overview-card info-3">
            <div class="card-label">Total Students</div>
            <div id="admin-students-count" class="card-value">‚Äî</div>
          </div>

          <div class="overview-card schedule">
            <div class="card-label">Pending Enrollments</div>
            <div id="admin-pending-count" class="card-value">‚Äî</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="compartments">
    <div class="compartment">
      <div id="add-class-modal" class="modal">
        <div class="modal-content">
          <div style="width: 100%">
            <span class="close-btn"
              ><svg
                width="24"
                height="24"
                viewBox="0 0 6.3499999 6.3499999"
                fill="none"
              >
                <path
                  id="rect1"
                  style="stroke-width: 0.454438"
                  d="M 0.56638171,-0.56638171 C 0.42177738,-0.42177738 0.33252088,-0.22160664 0.33252088,0 c 0,0.44321328 0.35666386,0.79987714 0.79987712,0.79987714 H 3.6902509 V 3.35773 c 0,0.4432133 0.3566639,0.7998772 0.7998772,0.7998772 0.4432132,0 0.7998771,-0.3566639 0.7998771,-0.7998772 V 0.79987714 h 2.5578529 c 0.4432133,0 0.7998771,-0.35666386 0.7998771,-0.79987714 0,-0.44321328 -0.3566638,-0.79987714 -0.7998771,-0.79987714 H 5.2900052 V -3.35773 c 0,-0.4432133 -0.3566639,-0.7998772 -0.7998771,-0.7998772 -0.4432133,0 -0.7998772,0.3566639 -0.7998772,0.7998772 v 2.55785286 H 1.132398 c -0.22160662,0 -0.42141195,0.0888911 -0.56601629,0.23349543 z"
                  transform="rotate(45)"
                />
              </svg>
            </span>
            <h2>Add New Class Schedule</h2>

            <form id="add-class-form">
              <div class="group bt-margin" style="max-width: 1000px">
                <label for="value-className" class="input-label"
                  >Class Name:</label
                >
                <select id="className" class="js-custom-dropdown" required>
                  <option value="">Select Class</option>
                </select>
                <br />
              </div>
              <div class="group bt-margin" style="max-width: 1000px">
                <label for="subjectName" class="input-label"
                  >Subject Name:</label
                >
                <select
                  id="subjectName"
                  name="ts_id"
                  class="js-custom-dropdown"
                  required
                  disabled
                >
                  <option value="">Select Subject</option>
                </select>
                <br />
              </div>

              <div
                class="js-time-picker group bt-margin"
                style="max-width: 1000px"
                data-hour-id="startHour"
                data-minute-id="startMinute"
                data-hidden-id="start_time_hidden"
              >
                <label for="startHour" class="input-label">Start Time:</label>

                <div class="time-selector-group">
                  <!-- Hour Dropdown -->
                  <select id="startHour" class="time-select-field"></select>

                  <span class="time-separator">:</span>

                  <!-- Minute Dropdown -->
                  <select id="startMinute" class="time-select-field"></select>
                </div>

                <!-- Hidden input for form submission -->
                <input
                  type="hidden"
                  name="start_time"
                  id="start_time_hidden"
                  value="09:00"
                />
              </div>

              <div
                class="js-time-picker group bt-margin"
                style="max-width: 1000px"
                data-hour-id="endHour"
                data-minute-id="endMinute"
                data-hidden-id="end_time_hidden"
              >
                <label for="endHour" class="input-label">End Time:</label>

                <div class="time-selector-group">
                  <!-- Hour Dropdown -->
                  <select id="endHour" class="time-select-field"></select>

                  <span class="time-separator">:</span>

                  <!-- Minute Dropdown -->
                  <select id="endMinute" class="time-select-field"></select>
                </div>

                <!-- Hidden input for form submission -->
                <input
                  type="hidden"
                  name="end_time"
                  id="end_time_hidden"
                  value="17:00"
                />
              </div>

              <div class="calendar-wrapper">
                <div
                  class="input-wrapper group bt-margin"
                  style="max-width: 1000px"
                >
                  <label for="modalDateInput" class="input-label"
                    >Class Date:</label
                  >
                  <input
                    type="text"
                    id="modalDateInput"
                    name="date"
                    class="date-input input"
                    placeholder="Click to select date"
                    readonly
                  />
                </div>
                <div class="calendar-container">
                  <div class="calendar-header">
                    <button type="button" class="cal-nav-btn prev-month-btn">
                      <svg
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path d="M15 18l-6-6 6-6" />
                      </svg>
                    </button>
                    <div class="month-year"></div>
                    <button type="button" class="cal-nav-btn next-month-btn">
                      <svg
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path d="M9 18l6-6-6-6" />
                      </svg>
                    </button>
                  </div>
                  <div class="calendar-grid"></div>
                </div>
              </div>

              <input type="hidden" name="day" id="day" />
              <input type="hidden" name="status" value="scheduled" />

              <button type="submit" class="submit-btn">Save Class</button>
            </form>
          </div>
        </div>
      </div>
      <div class="bt-margin"></div>
      <button class="add-class-btn" id="open-add-class-modal">
        Schedule Class
      </button>
    </div>
  </div>
  <div id="periodModal" class="modal" style="display: none">
    <div class="modal-content" style="max-width: 100%">
      <div style="width: 100%">
        <h2 id="periodModalTitle"></h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Roll No</th>
                <th>Name</th>
                <th>Present</th>
                <th>Absent</th>
              </tr>
            </thead>
            <tbody id="studentAttendanceList"></tbody>
          </table>
        </div>
        <span onclick="closePeriodModal()" class="close-btn"
          ><svg
            width="24"
            height="24"
            viewBox="0 0 6.3499999 6.3499999"
            fill="none"
          >
            <path
              id="rect1"
              style="stroke-width: 0.454438"
              d="M 0.56638171,-0.56638171 C 0.42177738,-0.42177738 0.33252088,-0.22160664 0.33252088,0 c 0,0.44321328 0.35666386,0.79987714 0.79987712,0.79987714 H 3.6902509 V 3.35773 c 0,0.4432133 0.3566639,0.7998772 0.7998772,0.7998772 0.4432132,0 0.7998771,-0.3566639 0.7998771,-0.7998772 V 0.79987714 h 2.5578529 c 0.4432133,0 0.7998771,-0.35666386 0.7998771,-0.79987714 0,-0.44321328 -0.3566638,-0.79987714 -0.7998771,-0.79987714 H 5.2900052 V -3.35773 c 0,-0.4432133 -0.3566639,-0.7998772 -0.7998771,-0.7998772 -0.4432133,0 -0.7998772,0.3566639 -0.7998772,0.7998772 v 2.55785286 H 1.132398 c -0.22160662,0 -0.42141195,0.0888911 -0.56601629,0.23349543 z"
              transform="rotate(45)"
            />
          </svg>
        </span>
      </div>
    </div>
  </div>

  <div class="compartments">
    <div class="compartment">
      <h2>Assigned Classes</h2>
      {% if assigned_classes %}
      <div class="table-container">
        <table id="assigned-classes-table">
          <thead>
            <tr>
              <th>Class</th>
              <th>Subject</th>
              <th>Subject Code</th>
              <th>Teacher</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for cls in assigned_classes %}
            <tr>
              <td>{{ cls['class_name'] }}</td>
              <td>{{ cls['subject'] }}</td>
              <td>{{ cls['subject_code'] }}</td>
              <td>{{ cls['teacher'] }}</td>
              <td>
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 6.3499999 6.3499999"
                  class="view-students"
                  fill="none"
                  onclick="viewClassStudents('{{ cls['id'] }}')"
                >
                  <path
                    id="rect2"
                    style="fill-opacity: 1; stroke-width: 0.278307"
                    d="M 1.9905633,4.5649819e-4 C 1.8262455,-0.00615141 1.6524289,0.05902133 1.5182407,0.19320962 1.2796837,0.43176659 1.2595679,0.79546623 1.4727654,1.0086637 l 2.164209,2.164209 -2.164209,2.1642089 C 1.2595679,5.5502791 1.2796836,5.9139787 1.5182407,6.1525358 1.7567976,6.3910927 2.1204973,6.4117253 2.3336948,6.1985278 L 4.9738437,3.5583789 C 5.1401298,3.3920927 5.1640316,3.1341312 5.0534253,2.915524 5.0290986,2.859759 4.994519,2.8085586 4.9495557,2.7635953 L 2.3336947,0.1477344 C 2.2404209,0.05446051 2.1183659,0.00559597 1.9905633,4.5649819e-4 Z"
                  />
                </svg>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %} {% if not assigned_classes %}
      <p>No classes assigned yet.</p>
      {% endif %}
    </div>
  </div>
  <div class="compartments">
    <!-- Admin Management Tables -->
    <div class="compartment">
      <h2>Teachers</h2>
      <div class="table-container">
        <div id="teachers-table"></div>
      </div>
    </div>

    <div class="compartment">
      <h2>Classes</h2>
      <div class="table-container">
        <div id="classes-table"></div>
      </div>
    </div>
  </div>
  <div class="compartments">
    <div id="studentModal" class="modal">
      <div class="modal-content" style="max-width: 100%">
        <div style="width: 100%">
          <h2 id="studentModalTitle"></h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Roll No</th>
                  <th>Name</th>
                  <th>Attended</th>
                  <th>Total</th>
                  <th>%</th>
                  <th>Image</th>
                </tr>
              </thead>
              <tbody id="studentList"></tbody>
            </table>
          </div>
          <span onclick="closeModal()" class="close-btn"
            ><svg
              width="24"
              height="24"
              viewBox="0 0 6.3499999 6.3499999"
              fill="none"
            >
              <path
                id="rect1"
                style="stroke-width: 0.454438"
                d="M 0.56638171,-0.56638171 C 0.42177738,-0.42177738 0.33252088,-0.22160664 0.33252088,0 c 0,0.44321328 0.35666386,0.79987714 0.79987712,0.79987714 H 3.6902509 V 3.35773 c 0,0.4432133 0.3566639,0.7998772 0.7998772,0.7998772 0.4432132,0 0.7998771,-0.3566639 0.7998771,-0.7998772 V 0.79987714 h 2.5578529 c 0.4432133,0 0.7998771,-0.35666386 0.7998771,-0.79987714 0,-0.44321328 -0.3566638,-0.79987714 -0.7998771,-0.79987714 H 5.2900052 V -3.35773 c 0,-0.4432133 -0.3566639,-0.7998772 -0.7998771,-0.7998772 -0.4432133,0 -0.7998772,0.3566639 -0.7998772,0.7998772 v 2.55785286 H 1.132398 c -0.22160662,0 -0.42141195,0.0888911 -0.56601629,0.23349543 z"
                transform="rotate(45)"
              />
            </svg>
          </span>
        </div>
      </div>
    </div>
    <div id="uploadModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" id="closeUploadModal">&times;</span>

        <h2>Upload Student Image</h2>
        <form
          id="uploadStudentImageForm"
          enctype="multipart/form-data"
          method="POST"
          action="/upload"
        >
          <div class="info-text">
            <h2 id="uploadModalTitle"></h2>
            Please select and upload images. You can select multiple images at
            once.
          </div>
          <div class="group bt-margin">
            <input
              class="input"
              type="text"
              name="student_id"
              placeholder="Student ID"
              id="studentIdInput"
              hidden
            />
          </div>

          <!-- Image Selector -->
          <div class="group bt-margin">
            <input
              class="input"
              type="file"
              id="studentImage"
              name="images"
              multiple
              accept="image/*"
              required
            />
          </div>

          <!-- Submit -->
          <button type="submit" class="submit-btn" id="uploadSubmitBtn">
            Upload
          </button>

          <!-- Loading Spinner -->
          <div
            id="uploadLoadingSpinner"
            style="display: none; text-align: center; margin-top: 1rem"
          >
            <div
              style="
                display: inline-block;
                width: 30px;
                height: 30px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
              "
            ></div>
            <p style="margin-top: 0.5rem; color: #666">Uploading images...</p>
          </div>
        </form>
      </div>
    </div>

    <!-- Student Images Modal -->
    <div id="imagesModal" class="modal" style="display: none">
      <div class="modal-content" style="max-width: 600px">
        <div style="width: 100%">
          <h2 id="imagesModalTitle">Student Images</h2>

          <!-- Image Stats -->
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 1rem;
              margin-bottom: 1rem;
              padding: 1rem;
              background: var(--bg-light);
              border-radius: 8px;
            "
          >
            <div style="text-align: center">
              <div style="font-size: 0.9rem; color: var(--text-muted)">
                Total Images
              </div>
              <div
                id="totalImagesCount"
                style="
                  font-size: 1.8rem;
                  font-weight: bold;
                  color: var(--primary);
                "
              >
                0
              </div>
            </div>
            <div style="text-align: center">
              <div style="font-size: 0.9rem; color: var(--text-muted)">
                With Encodings
              </div>
              <div
                id="encodedImagesCount"
                style="
                  font-size: 1.8rem;
                  font-weight: bold;
                  color: var(--success);
                "
              >
                0
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem">
            <button
              onclick="handleAddImages()"
              class="submit-btn"
              style="flex: 1; background: var(--primary)"
            >
              + Add Images
            </button>
            <button
              onclick="handleGenerateEncodings()"
              class="submit-btn"
              style="flex: 1; background: var(--success)"
            >
              üîß Generate Encodings
            </button>
            <button
              onclick="handleShowImages()"
              class="submit-btn"
              style="flex: 1; background: var(--info)"
            >
              üëÅÔ∏è Show Images
            </button>
          </div>

          <!-- Images List -->
          <div
            class="table-container"
            style="max-height: 400px; overflow-y: auto"
          >
            <table>
              <thead>
                <tr>
                  <th>File Name</th>
                  <th>Encoding</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="imagesList"></tbody>
            </table>
          </div>

          <!-- Loading Indicator -->
          <div
            id="imagesLoadingIndicator"
            style="
              display: none;
              text-align: center;
              padding: 1rem;
              color: var(--text-muted);
            "
          >
            <div style="animation: spin 1s linear infinite">‚è≥</div>
            Processing...
          </div>

          <span onclick="closeImagesModal()" class="close-btn"
            ><svg
              width="24"
              height="24"
              viewBox="0 0 6.3499999 6.3499999"
              fill="none"
            >
              <path
                id="rect1"
                style="stroke-width: 0.454438"
                d="M 0.56638171,-0.56638171 C 0.42177738,-0.42177738 0.33252088,-0.22160664 0.33252088,0 c 0,0.44321328 0.35666386,0.79987714 0.79987712,0.79987714 H 3.6902509 V 3.35773 c 0,0.4432133 0.3566639,0.7998772 0.7998772,0.7998772 0.4432132,0 0.7998771,-0.3566639 0.7998771,-0.7998772 V 0.79987714 h 2.5578529 c 0.4432133,0 0.7998771,-0.35666386 0.7998771,-0.79987714 0,-0.44321328 -0.3566638,-0.79987714 -0.7998771,-0.79987714 H 5.2900052 V -3.35773 c 0,-0.4432133 -0.3566639,-0.7998772 -0.7998771,-0.7998772 -0.4432133,0 -0.7998772,0.3566639 -0.7998772,0.7998772 v 2.55785286 H 1.132398 c -0.22160662,0 -0.42141195,0.0888911 -0.56601629,0.23349543 z"
                transform="rotate(45)"
              />
            </svg>
          </span>
        </div>
      </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="imageViewerModal" class="modal" style="display: none">
      <div
        class="modal-content"
        style="
          max-width: 90vw;
          max-height: 90vh;
          display: flex;
          flex-direction: column;
          position: relative;
        "
      >
        <span
          onclick="closeImageViewerModal()"
          class="close-btn"
          style="position: absolute; right: 1rem; top: 1rem; z-index: 10"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 6.3499999 6.3499999"
            fill="none"
          >
            <path
              style="stroke-width: 0.454438"
              d="M 0.56638171,-0.56638171 C 0.42177738,-0.42177738 0.33252088,-0.22160664 0.33252088,0 c 0,0.44321328 0.35666386,0.79987714 0.79987712,0.79987714 H 3.6902509 V 3.35773 c 0,0.4432133 0.3566639,0.7998772 0.7998772,0.7998772 0.4432132,0 0.7998771,-0.3566639 0.7998771,-0.7998772 V 0.79987714 h 2.5578529 c 0.4432133,0 0.7998771,-0.35666386 0.7998771,-0.79987714 0,-0.44321328 -0.3566638,-0.79987714 -0.7998771,-0.79987714 H 5.2900052 V -3.35773 c 0,-0.4432133 -0.3566639,-0.7998772 -0.7998771,-0.7998772 -0.4432133,0 -0.7998772,0.3566639 -0.7998772,0.7998772 v 2.55785286 H 1.132398 c -0.22160662,0 -0.42141195,0.0888911 -0.56601629,0.23349543 z"
              transform="rotate(45)"
            />
          </svg>
        </span>
        <div
          style="
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            position: relative;
          "
        >
          <button
            id="imageNavPrev"
            onclick="prevImage()"
            style="
              position: absolute;
              left: 1rem;
              background: rgba(0, 0, 0, 0.5);
              color: white;
              border: none;
              padding: 1rem;
              border-radius: 50%;
              cursor: pointer;
              display: none;
              z-index: 5;
            "
          >
            ‚Üê
          </button>
          <img
            id="imageViewerImg"
            src=""
            alt="Student Image"
            style="max-width: 100%; max-height: 100%; object-fit: contain"
          />
          <button
            id="imageNavNext"
            onclick="nextImage()"
            style="
              position: absolute;
              right: 1rem;
              background: rgba(0, 0, 0, 0.5);
              color: white;
              border: none;
              padding: 1rem;
              border-radius: 50%;
              cursor: pointer;
              display: none;
              z-index: 5;
            "
          >
            ‚Üí
          </button>
        </div>
        <div
          style="text-align: center; padding: 1rem; background: var(--bg-light)"
        >
          <span id="imageViewerName" style="font-weight: bold"></span>
        </div>
      </div>
    </div>

    <div class="compartment">
      <h2>Class Timetables</h2>
      {% if timetables %}
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Class</th>
              <th>Day</th>
              <th>Subject</th>
              <th>Teacher</th>
              <th>Start Time</th>
              <th>End Time</th>
            </tr>
          </thead>
          <tbody>
            {% for period in timetables %}
            <tr>
              <td>{{ period['class_name'] }}</td>
              <td>{{ period['day'] }}</td>
              <td>{{ period['subject_name'] }}</td>
              <td>{{ period['teacher_name'] }}</td>
              <td>{{ period['start_time'] }}</td>
              <td>{{ period['end_time'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %} {% if not timetables %}
      <p>No timetables available.</p>
      {% endif %}
    </div>
  </div>
  <div class="compartments">
    <div class="compartment">
      <h2>Assign Students to Classes</h2>
      {% if pending_students %}
      <div class="student-card-container" id="student-card-container">
        {% for student in pending_students %}
        <div class="student-card" data-student-id="{{student.id}}">
          <div class="student-card-info">
            <p class="student-name">{{student.name}}</p>
            <p class="student-id">ID: {{student.id}}</p>
            <p class="student-roll_no">Roll No: {{student.roll_no}}</p>
          </div>

          <div class="student-card-content">
            <select
              class="student-class js-custom-dropdown"
              id="classStudents-{{student.id}}"
              data-student-id="{{student.id}}"
            >
              <option value="">Select Class</option>
              {% for cls in classes %}
              <option value="{{ cls['id'] }}">{{ cls['name'] }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="card-actions">
            <button
              class="action-button enroll-btn"
              data-id="{{student.id}}"
              title="Confirm enrollment"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </button>
            <button
              class="action-button reject-btn"
              data-id="{{student.id}}"
              title="Reject enrollment"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p>No students available to assign.</p>
      {% endif %}
    </div>

    <!-- Assign Teachers section removed from admin dashboard -->
  </div>
  <div class="compartments">
    <div class="compartment">
      <h2>All Students Attendance</h2>
      <div
        class="filter-controls"
        id="teacher-filter-controls"
        data-table-id="attendance-table"
      >
        <div class="group" style="flex: 1">
          <select name="class" id="class_filter" class="js-custom-dropdown">
            <option value="">All Classes</option>
            {% for cls in classes %}
            <option value="{{ cls['name'] | trim | lower }}">
              {{ cls['name'] }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="group" style="flex: 1">
          <select name="student" id="student_filter" class="js-custom-dropdown">
            <option value="">All Students</option>
            {% for student in students %}
            <option value="{{ student['name'] | trim | lower }}">
              {{ student['name'] }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="group" style="flex: 1">
          <select name="subject" id="subject_filter" class="js-custom-dropdown">
            <option value="">All Subjects</option>
            {% for subject in subjects %}
            <option value="{{ subject['name'] | trim | lower }}">
              {{ subject['name'] }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="calendar-wrapper" style="flex: 1">
          <div class="input-wrapper group">
            <input
              type="text"
              id="filterDateInput"
              class="date-input input"
              placeholder="Filter by date"
              readonly
            />
          </div>
          <div class="calendar-container">
            <div class="calendar-header">
              <button type="button" class="cal-nav-btn prev-month-btn">
                <svg
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </button>
              <div class="month-year"></div>
              <button type="button" class="cal-nav-btn next-month-btn">
                <svg
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M9 18l6-6-6-6" />
                </svg>
              </button>
            </div>
            <div class="calendar-grid"></div>
          </div>
        </div>
        <div class="group" style="flex: 1">
          <select name="status" id="status_filter" class="js-custom-dropdown">
            <option value="">All Statuses</option>
            <option value="present">Present</option>
            <option value="absent">Absent</option>
          </select>
        </div>

        <div class="group" style="flex: 1">
          <select name="day" id="day_filter" class="js-custom-dropdown">
            <option value="">All Days</option>
            <option value="monday">Monday</option>
            <option value="tuesday">Tuesday</option>
            <option value="wednesday">Wednesday</option>
            <option value="thursday">Thursday</option>
            <option value="friday">Friday</option>
            <option value="saturday">Saturday</option>
            <option value="sunday">Sunday</option>
          </select>
        </div>
        <button
          type="button"
          class="submit-btn"
          onclick="resetFilters('teacher-filter-controls')"
        >
          Reset Filters
        </button>
      </div>
      {% if attendance %}
      <div class="table-container">
        <table id="attendance-table">
          <thead>
            <tr>
              <th>Class</th>
              <th>Name</th>
              <th>Roll No</th>
              <th>Date</th>
              <th>Subject</th>
              <th>Day</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for row in attendance %}
            <tr>
              <td>{{ row['class_name'] }}</td>
              <td>{{ row['name'] }}</td>
              <td>{{ row['roll_no'] }}</td>
              <td>{{ row['date'] }}</td>
              <td>{{ row['subject'] }}</td>
              <td>{{ row['day'] }}</td>
              <td>{{ row['status'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p>No attendance records found.</p>
      {% endif %}
    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Populate overview statistics cards
    const classesCountEl = document.getElementById("admin-classes-count");
    const teachersCountEl = document.getElementById("admin-teachers-count");
    const studentsCountEl = document.getElementById("admin-students-count");
    const pendingCountEl = document.getElementById("admin-pending-count");

    if (classesCountEl) classesCountEl.textContent = "{{ total_classes }}";
    if (teachersCountEl) teachersCountEl.textContent = "{{ total_teachers }}";
    if (studentsCountEl) studentsCountEl.textContent = "{{ total_students }}";
    if (pendingCountEl) pendingCountEl.textContent = "{{ pending_count }}";

    // Get the elements
    const modal = document.getElementById("add-class-modal");
    const openBtn = document.getElementById("open-add-class-modal");
    const closeBtn = document.querySelector(".close-btn");
    const form = document.getElementById("add-class-form");
    const message = document.getElementById("modal-message");
    window.allClasses = {{ classes | tojson }};
    const ALL_CLASSES = {{ classes | tojson }};

    // Expose admin data for Tabulator tables
    window.pendingStudents = {{ pending_students | tojson }};
    window.adminTeachers = {{ teachers | tojson }};
    window.adminClasses = {{ classes | tojson }};
    window.adminSubjects = {{ subjects | tojson }};

    const classNames = [...new Set(ALL_CLASSES.map(row => row.class_name))];
    const classNamesWithIds = Object.values(
      ALL_CLASSES.reduce((accumulator, row) => {
        accumulator[row.id] = { class_name: row.class_name, id: row.id };
        return accumulator;
      }, {})
    );
    // Populate subject dropdown based on selected class
    const classSelect = document.getElementById("className");
    const subjectSelect = document.getElementById("subjectName");

    const teacherSelect = document.getElementById("teacherSelect");
    const teacherClassSelect = document.getElementById("teacherClass");
    const teacherSubjectSelect = document.getElementById("teacherSubject");

    // Initialize Tabulator tables if available
    if (typeof Tabulator !== 'undefined') {
        // pending-enrollments removed (assign students UI replaces it)

      // Teachers table
      new Tabulator("#teachers-table", {
        data: window.adminTeachers || [],
        layout: "fitColumns",
        resizableColumns: true,
        columns: [
          { title: "ID", field: "id", width: 70 },
          { title: "Name", field: "name" }
        ]
      });

      // Classes table
      new Tabulator("#classes-table", {
        data: window.adminClasses || [],
        layout: "fitColumns",
        resizableColumns: true,
        columns: [
          { title: "ID", field: "id", width: 70 },
          { title: "Class Name", field: "name" }
        ]
      });
    }

    // --- MODAL DROPDOWN LOGIC ---

    // 1. Define the function that updates the subject dropdown
    function updateSubjectDropdown(selectedClass, subjectWrapper) {
      // Find the wrapper that the custom dropdown created.
      if (!subjectWrapper) return;

      // Create a new <select> element to replace the old one.
      const newSubjectSelect = document.createElement("select");
      newSubjectSelect.id = subjectWrapper.id.replace("wrapper-", "");
      newSubjectSelect.name = "ts_id";  // Keep this name for form submission
      newSubjectSelect.className = "js-custom-dropdown";
      newSubjectSelect.required = true;

      const subjects = ALL_CLASSES.filter(row => row.class_name === selectedClass);
      newSubjectSelect.disabled = subjects.length === 0;

      // Populate the new select element with ts_id (TeacherSubject.id) as value
      newSubjectSelect.innerHTML = '<option value="">Select Subject</option>' +
        subjects.map(sub => `<option value="${sub.id}">${sub.subject}</option>`).join('');

      // Replace the old wrapper with our new, clean <select> element
      subjectWrapper.parentNode.replaceChild(newSubjectSelect, subjectWrapper);

      // Now, transform the new <select> into a custom dropdown
      transformSelectToCustomDropdown(newSubjectSelect);
    }
    // 2. Populate and transform the class dropdown initially
    classSelect.innerHTML = '<option value="">Select Class</option>' +
      classNames.map(cls => `<option value="${cls}">${cls}</option>`).join('');

    // 3. Perform an initial setup for the subject dropdowns FIRST
    transformSelectToCustomDropdown(subjectSelect);

    if (teacherSubjectSelect) transformSelectToCustomDropdown(teacherSubjectSelect);

    // Now set up the class dropdowns with callbacks that reference the already-transformed subject wrappers
    transformSelectToCustomDropdown(classSelect, (value) => {
      const subjectWrapper = document.getElementById("wrapper-subjectName");
      if (!subjectWrapper) return;
      updateSubjectDropdown(value, subjectWrapper);
    });

    if (teacherClassSelect) {
      teacherClassSelect.innerHTML = '<option value="">Select Class</option>' +
        classNamesWithIds.map(cls => `<option value="${cls.id}">${cls.class_name}</option>`).join('');

      transformSelectToCustomDropdown(teacherClassSelect, (value) => {
        const subjectWrapper = document.getElementById("wrapper-teacherSubject");
        if (!subjectWrapper) return;
        updateSubjectDropdown(value, subjectWrapper);
      });
    }

    if (teacherSelect) transformSelectToCustomDropdown(teacherSelect);


    // --- END MODAL DROPDOWN LOGIC ---

    // Function to open the modal
    openBtn.onclick = function () {
      modal.style.display = "flex";
      form.reset(); // Clear the form fields

      // Reset dropdowns to their initial state when opening
      // This will now correctly rebuild and re-initialize the dropdowns
    };

    // Function to close the modal using the (x) button
    closeBtn.onclick = function () {
      modal.style.display = "none";
    };

    // Function to close the modal when clicking outside the content
    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };

    // üí° Attach the form submission handler here
    form.addEventListener("submit", handleAddClassSubmit);

    // Listen for date selection on the filter calendar

    document.querySelectorAll('.enroll-btn').forEach(btn => {
      btn.addEventListener('click', handleStudentEnroll);
    });
    document.querySelectorAll('.reject-btn').forEach(btn => {
      btn.addEventListener('click', handleStudentReject);
    });

  });

  function viewClassStudents(tsId) {
    const classes = {{ classes | tojson }};
    fetch(`/admin/api/classes/${tsId}/students`)
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById("studentList");
        tbody.innerHTML = "";
        data.forEach(s => {
          const attended = s.attended || 0;
          const totalClasses = s.total_classes || 0;
          const percentage = (attended / totalClasses) * 100 || 0;
          const color = s.percentage >= 75 ? 'green' : s.percentage >= 50 ? 'orange' : 'red';
          tbody.innerHTML += `
            <tr>
              <td>${s.roll_no}</td>
              <td>${s.name}</td>
              <td>${attended}</td>
              <td>${totalClasses}</td>
              <td style="color:${color}">${percentage}%</td>
              <td>
                <button onclick="viewStudentImages('${s.id}', '${s.name}')">
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 6.3499999 6.3499999"
                    class="view-students"
                    fill="none"
                  >
                    <path
                      id="rect2"
                      style="fill-opacity: 1; stroke-width: 0.278307"
                      d="M 1.9905633,4.5649819e-4 C 1.8262455,-0.00615141 1.6524289,0.05902133 1.5182407,0.19320962 1.2796837,0.43176659 1.2595679,0.79546623 1.4727654,1.0086637 l 2.164209,2.164209 -2.164209,2.1642089 C 1.2595679,5.5502791 1.2796836,5.9139787 1.5182407,6.1525358 1.7567976,6.3910927 2.1204973,6.4117253 2.3336948,6.1985278 L 4.9738437,3.5583789 C 5.1401298,3.3920927 5.1640316,3.1341312 5.0534253,2.915524 5.0290986,2.859759 4.994519,2.8085586 4.9495557,2.7635953 L 2.3336947,0.1477344 C 2.2404209,0.05446051 2.1183659,0.00559597 1.9905633,4.5649819e-4 Z"
                    />
                  </svg>
                </button>
              </td>
            </tr>`;
        });
        document.getElementById("studentModal").style.display = "flex";
        document.getElementById("studentModalTitle").textContent = classes.find(c => c.id == tsId).class_name;
      });
  }
  document
    .getElementById("uploadStudentImageForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById("uploadSubmitBtn");
      const spinner = document.getElementById("uploadLoadingSpinner");
      const fileInput = document.getElementById("studentImage");

      let formData = new FormData(e.target);
      const studentId = formData.get("student_id");

      // Show loading spinner and disable submit button
      submitBtn.disabled = true;
      fileInput.disabled = true;
      spinner.style.display = "block";

      try {
        let res = await fetch("/admin/upload", {
          method: "POST",
          body: formData,
        });

        if (res.ok) {
          showToast("Image uploaded successfully!", "success");
          document.getElementById("uploadModal").style.display = "none";
          // Reset form
          e.target.reset();
          // Refresh the images modal if it's open
          if (window.currentStudentId) {
            loadStudentImages(window.currentStudentId);
          }
        } else {
          showToast("Image upload failed", "error");
        }
      } catch (error) {
        showToast("Upload error: " + error.message, "error");
      } finally {
        // Hide loading spinner and re-enable submit button
        submitBtn.disabled = false;
        fileInput.disabled = false;
        spinner.style.display = "none";
      }
    });


  setInterval(updatePeriods, 60000);
  updatePeriods();
</script>

{% endblock %}
