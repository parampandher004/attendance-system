{% extends "base.html" %} {% block title %}Student Dashboard{% endblock %} {%
block content %}
<div class="dashboard-container">
  <div class="header">
    <h2>Welcome, {{ session.name }}</h2>
    <h3>{{ session.class_name }}</h3>
    <a class="logout-btn" href="/logout">Logout</a>
    <div
      class="toggle-switch"
      style="position: relative; scale: 0.7; top: auto; right: auto"
    >
      <label class="slider-label">
        <input
          type="checkbox"
          class="slider-input"
          onclick="toggleDarkMode()"
        />
        <span class="slider"></span>
      </label>
    </div>
  </div>
  <main>
    <div class="compartments">
      <div class="compartment">
        <h2>Today's Periods</h2>
        <div class="table-container">
          <table id="periods-table" style="display: none">
            <thead>
              <tr>
                <th>Subject Name</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="periods-body"></tbody>
          </table>
        </div>

        <p id="no-periods-message" style="display: none">
          No periods scheduled for today.
        </p>
      </div>
    </div>
    {% if session.class_name %}
    <div class="compartments">
      <div class="compartment">
        <h2>Assigned Subjects</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Subject Code</th>
                <th>Subject Name</th>
                <th>Teacher Name</th>
                <th>Attended</th>
                <th>Total</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody>
              {% for subject in subjects %}
              <tr>
                <td>{{ subject['subject_code'] }}</td>
                <td>{{ subject['subject'] }}</td>
                <td>{{ subject['teacher'] }}</td>
                <td>{{ subject['attended'] }}</td>
                <td>{{ subject['total_classes'] }}</td>
                <td>{{ subject['percentage'] | int }}%</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="compartment">
        <h2>Class Timetable</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Day</th>
                <th>Subject Name</th>
                <th>Start Time</th>
                <th>End Time</th>
              </tr>
            </thead>
            <tbody>
              {% for timetable in timetables %}
              <tr>
                <td>{{ timetable['day'] }}</td>
                <td>{{ timetable['subject_name'] }}</td>
                <td>{{ timetable['start_time'] }}</td>
                <td>{{ timetable['end_time'] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% else %}
        <p>No class assigned yet.</p>
        {% endif %}
      </div>
    </div>

    <div class="compartments">
      <div class="compartment">
        <h2>Student Attendance</h2>
        <div
          class="filter-controls"
          id="student-filter-controls"
          data-table-id="attendance-table"
        >
          <div class="group">
            <label for="st_subject_filter">Subject:</label>
            <select
              name="subject"
              id="st_subject_filter"
              class="js-custom-dropdown"
            >
              <option value="">All Subjects</option>
              {% for subject in subjects %}
              <option value="{{ subject['subject'] | trim | lower }}">
                {{ subject['subject'] }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="calendar-wrapper">
            <div class="input-wrapper group">
              <label for="stFilterDateInput" class="input-label">Date:</label>
              <input
                type="text"
                id="stFilterDateInput"
                class="date-input input"
                placeholder="Filter by date"
                readonly
              />
            </div>
            <div class="calendar-container">
              <div class="calendar-header">
                <button type="button" class="cal-nav-btn prev-month-btn">
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M15 18l-6-6 6-6" />
                  </svg>
                </button>
                <div class="month-year"></div>
                <button type="button" class="cal-nav-btn next-month-btn">
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M9 18l6-6-6-6" />
                  </svg>
                </button>
              </div>
              <div class="calendar-grid"></div>
            </div>
          </div>
          <div class="group">
            <label for="st_status_filter">Status:</label>
            <select
              name="status"
              id="st_status_filter"
              class="js-custom-dropdown"
            >
              <option value="">All Statuses</option>
              <option value="present">Present</option>
              <option value="absent">Absent</option>
            </select>
          </div>
          <div class="group">
            <label for="st_day_filter">Day:</label>
            <select name="day" id="st_day_filter" class="js-custom-dropdown">
              <option value="">All Days</option>
              <option value="monday">Monday</option>
              <option value="tuesday">Tuesday</option>
              <option value="wednesday">Wednesday</option>
              <option value="thursday">Thursday</option>
              <option value="friday">Friday</option>
              <option value="saturday">Saturday</option>
              <option value="sunday">Sunday</option>
            </select>
          </div>

          <button
            type="button"
            class="submit-btn"
            onclick="resetFilters('student-filter-controls')"
          >
            Reset Filters
          </button>
        </div>
        <div class="table-container">
          <table id="attendance-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Subject</th>
                <th>Day</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for row in attendance %}
              <tr>
                <td>{{ row['date'] }}</td>
                <td>{{ row['subject'] }}</td>
                <td>{{ row['day'] }}</td>
                <td>{{ row['status'] }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>
<script src="{{ url_for('static', filename='custom-calendar.js') }}"></script>
<script src="{{ url_for('static', filename='custom-dropdown.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Listen for date selection on the student filter calendar
    const stFilterDateInput = document.getElementById("stFilterDateInput");
    if (stFilterDateInput) {
      stFilterDateInput.addEventListener("dateSelected", (e) => {
        // Call your filter function when a date is selected
        studentApplyFilters(e.detail.date, null, "st_date_filter");
      });
    }
  });
  function updatePeriods() {
    const table = document.getElementById("periods-table");
    const tbody = document.getElementById("periods-body");
    const noPeriodsMessage = document.getElementById("no-periods-message");

    tbody.innerHTML = "";
    noPeriodsMessage.style.display = "none";

    fetch("/api/periods/today")
      .then((response) => response.json())
      .then((data) => {
        if (data.length > 0) {
          table.style.display = "table";
          data.forEach((period) => {
            let row = document.createElement("tr");
            row.classList.add("status-" + period.status.toLowerCase());
            row.innerHTML = `
              <td>${period.subject_name}</td>
              <td>${period.start_time}</td>
              <td>${period.end_time}</td>
              <td>${period.status.toUpperCase()}</td>
            `;
            tbody.appendChild(row);
          });
        } else {
          noPeriodsMessage.style.display = "block";
        }
      })
      .catch((error) => {
        noPeriodsMessage.textContent =
          "Error fetching periods. Please try again later.";
        noPeriodsMessage.style.display = "block";
      });
  }
  setInterval(updatePeriods, 60000);
  updatePeriods();
</script>
{% endblock %}
